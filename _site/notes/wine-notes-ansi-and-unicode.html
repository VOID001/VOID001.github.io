<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Wine Notes AnsiString and Unicode String</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@" /><meta name="twitter:title" content="Wine Notes AnsiString and Unicode String" /><meta name="twitter:description" content="Windows下有两种字符的格式 Unicode 和 ANSI, Windows下的很多API(Rtl系列, 之类的) 是需要认清二者的区别的"><meta name="description" content="Windows下有两种字符的格式 Unicode 和 ANSI, Windows下的很多API(Rtl系列, 之类的) 是需要认清二者的区别的"><meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o"><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/notes/wine-notes-ansi-and-unicode"><link rel="alternate" type="application/atom+xml" title="VOID's Notes" href="/feed.xml" /></head><body><aside class="logo"> <a href="/"> <img src="/assets/avatar.jpeg" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Wine Notes AnsiString and Unicode String</h1><time>February 12, 2016</time></div><div class="divider"></div><p>Windows下有两种字符的格式 <strong>Unicode</strong> 和 <strong>ANSI</strong>, Windows下的很多API(Rtl系列, 之类的) 是需要认清二者的区别的</p><div class="divider"></div><h3 id="section">二者的对比</h3><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#ifndef __STRING_DEFINED__
#define __STRING_DEFINED__
</span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_STRING</span> <span class="p">{</span>
  <span class="n">USHORT</span> <span class="n">Length</span><span class="p">;</span>
  <span class="n">USHORT</span> <span class="n">MaximumLength</span><span class="p">;</span>
  <span class="n">PCHAR</span> <span class="n">Buffer</span><span class="p">;</span>
<span class="p">}</span> <span class="n">STRING</span><span class="p">,</span> <span class="o">*</span><span class="n">PSTRING</span><span class="p">;</span>
<span class="cp">#endif
</span>
<span class="k">typedef</span> <span class="n">STRING</span> <span class="n">ANSI_STRING</span><span class="p">;</span></code></pre></figure><p>而<code class="highlighter-rouge">PCHAR</code> 是　<code class="highlighter-rouge">char*</code> 的一个定义 , 因而ANSI_STRING 每一个字符占一个字节(sizeof(char))</p><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#ifndef __UNICODE_STRING_DEFINED__
#define __UNICODE_STRING_DEFINED__
</span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_UNICODE_STRING</span> <span class="p">{</span>
  <span class="n">USHORT</span> <span class="n">Length</span><span class="p">;</span>        <span class="cm">/* bytes */</span>
  <span class="n">USHORT</span> <span class="n">MaximumLength</span><span class="p">;</span> <span class="cm">/* bytes */</span>
  <span class="n">PWSTR</span>  <span class="n">Buffer</span><span class="p">;</span>
<span class="p">}</span> <span class="n">UNICODE_STRING</span><span class="p">,</span> <span class="o">*</span><span class="n">PUNICODE_STRING</span><span class="p">;</span>
<span class="cp">#endif
</span>
<span class="k">typedef</span> <span class="k">const</span> <span class="n">UNICODE_STRING</span> <span class="o">*</span><span class="n">PCUNICODE_STRING</span><span class="p">;</span></code></pre></figure><p>这里的 PWSTR 的定义是 WCHAR*, 即宽字符指针, 查看WCHAR的定义后知, WCHAR为 (unsigned short) 型(16bit char)</p><div class="divider"></div><h3 id="wchar-">初始化WCHAR 的时候要用下面这种形式进行初始化:</h3><figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">WCHAR</span> <span class="n">sample_1</span><span class="p">[]</span> <span class="o">=</span> <span class="s">L"Example"</span><span class="p">;</span>
<span class="n">WCHAR</span> <span class="n">sample_2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="sc">'E'</span><span class="p">,</span> <span class="sc">'x'</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="sc">'m'</span><span class="p">,</span> <span class="sc">'p'</span><span class="p">,</span> <span class="sc">'l'</span><span class="p">,</span> <span class="sc">'e'</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span></code></pre></figure><p>一定要注意第二种形式最后的 <code class="highlighter-rouge">0</code></p><div class="divider"></div><h3 id="wchar-char-">WCHAR, char 之间的转换</h3><p>二者之间的转换可以通过两个函数来完成, 先将char的字符串转为 <code class="highlighter-rouge">ANSI_STRING</code>, 然后将<code class="highlighter-rouge">ANSI_STRING</code>,转为<code class="highlighter-rouge">UNICODE_STRING</code>, 从而<code class="highlighter-rouge">UNICODE_STRING</code>中的<code class="highlighter-rouge">Buffer</code>即为转换后的结果</p><p>参考Sebastian Lackner 的<a href="http://pastebin.com/raw/m43tkLdT">Sample</a></p><p>通过 <code class="highlighter-rouge">RtlInitAnsiString</code> 将 <code class="highlighter-rouge">filename</code> 的内容写入一个<code class="highlighter-rouge">ANSI_STRING</code> <code class="highlighter-rouge">dospath</code> 内, 然后调用 <code class="highlighter-rouge">RtlAnsiStringToUnicodeString</code> 并且设置 <code class="highlighter-rouge">AllocateDestinationString</code> 为 TRUE, 让这个函数自行分配内存给dospathW, 要注意这种方式分配的内存要用 <code class="highlighter-rouge">RtlFreeUnicodeString</code> 手动回收</p><div class="divider"></div><h3 id="wine-wchar">Wine 下打印WCHAR</h3><p>使用函数 wine_dbgstr_* 系列函数, 这里使用 wine_dbgstr_w, 打印宽字符</p><h3 id="section-1"><em>防止内存泄露</em></h3><ul><li>使用RtlInitAnsiString创建的字符串不需要手动Free</li><li>使用RtlAnsiStringToUnicodeString, 并且 AllocateDestinationString 为 TRUE 的话需要手动释放内存</li><li>使用wine_nt_to_unix_filename 得到的ANSI_STRING 需要手动释放内存</li></ul></article><div class="back"> <a href="/">Back</a></div></main><div style="text-align: center">@<a href="http://github.com/VOID001">VOID001</a></div></body></html>